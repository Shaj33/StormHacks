<!DOCTYPE html>
<html lang="en">
<head>
  <title>Watch and Chat</title>
  <link rel="stylesheet" href="session.css">
</head>
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.1/socket.io.min.js"></script>
  
  <header>
    <h1>Watch and Chat</h1>
  </header>
  
  <div id="player" class="player"></div>

  <div class="search">
    <input class="seachBar" name="videoUrl" type="text" id="videoUrl" placeholder="youtube video link"/>
  </div>
  <div class="searchBtnCont">
    <button class="searchBtn" onclick="loadVideo()">Load Video</button>
  </div>
  
  <script type="text/javascript">
    // 2. This code loads the IFrame Player API code asynchronously.
    var tag = document.createElement('script');
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.
    var player;
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: 'M7lc1UVf-VE',
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {
      event.target.playVideo();
      player.playVideo();
    }

    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.
    changing = false
    function onPlayerStateChange(event) {
        console.log(event.data);
      if ((event.data == 1 || event.data == 2) && !changing) {
        let time = getSec();
        socket.emit( 'videoChange', {
            time: time,
            state: event.data
        })
        console.log("Hey")
      }
    }
    
    function playfrom(start) {
      player.seekTo(start, true)
      changing = true;
      player.playVideo();
      setTimeout(() => {
          changing = false;
      }, 1000);
    }

    function getSec() {
        return Math.round(player.getCurrentTime()*100)/100;
    }

    socket.on( 'changeVideo', (change) => {
        console.log(change.time)
        if (change.state == 1) { 
            playfrom(change.time);
        } else if (change.state == 2) {
            player.pauseVideo();
        }
    } )

    //Function to load desired video
    function loadVideo() {

      var x = document.getElementById("videoUrl").value;
      console.log(x.split("v=")[1].substring(0, 11))

      player.loadVideoById({
        videoId: x.split("v=")[1].substring(0, 11),
        startSeconds: 0
      });

    }
  </script>
  <h3 style='color: #ccc;font-size: 30px;'>No message yet..</h3>
  <div id="messages" class="message_holder"></div>
  <form action="" method="POST">
    <input type="text" class="username" placeholder="User Name"/>
    <input type="text" class="message" placeholder="Messages"/>
    <input type="submit"/>
  </form>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script type="text/javascript">
    var socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on( 'connect', function() {
      socket.emit( 'my event', {
        data: 'User Connected'
      } )
      var form = $( 'form' ).on( 'submit', function( e ) {
        e.preventDefault()
        let user_name = $( 'input.username' ).val()
        let user_input = $( 'input.message' ).val()
        socket.emit( 'my event', {
          user_name : user_name,
          message : user_input
        } )
        $( 'input.message' ).val( '' ).focus()
      } )
    } )
    socket.on( 'my response', function( msg ) {
      console.log( msg )
      if( typeof msg.user_name !== 'undefined' ) {
        $( 'h3' ).remove()
        $( 'div.message_holder' ).append( '<div><b style="color: #000">'+msg.user_name+'</b> '+msg.message+'</div>' )
      }
    })

    document.getElementById("messages").setAttribute("style","overflow:auto;height:90px;width:500px");

  </script>

</body>
</html>